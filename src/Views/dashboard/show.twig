{% extends "layouts/base.twig" %}

{% block title %}{{ url.name ?? url.url.value }} - Beacon Audit{% endblock %}

{% block page_header %}
    <div class="flex items-center gap-3 text-sm">
        <div class="flex items-center gap-2">
            <a href="/" class="text-text-muted hover:text-text-secondary transition-colors">Dashboard</a>
            <span class="text-text-muted">/</span>
            <span class="text-text-primary font-medium truncate max-w-[200px]">{{ url.name ?? url.url.value }}</span>
            <a href="{{ url.url.value }}" target="_blank" rel="noopener noreferrer" class="text-xs text-text-muted hover:text-text-secondary underline underline-offset-2 decoration-stone-300 hover:decoration-stone-400 transition-colors ml-1">{{ url.url.value }}</a>
        </div>
        <div class="flex items-center gap-2 ml-2">
            {% if latestScore is not null %}
                <span class="inline-flex items-center h-5.5 px-2 rounded-md text-[11px] font-medium {% if latestScore >= 90 %}bg-badge-excellent-bg text-badge-excellent-text{% elseif latestScore >= 70 %}bg-badge-good-bg text-badge-good-text{% else %}bg-badge-poor-bg text-badge-poor-text{% endif %}">Score {{ latestScore }}</span>
            {% endif %}
            <span class="inline-flex items-center h-5.5 px-2 rounded-md text-[11px] font-medium
                {% if trend.value == 'improving' %}bg-badge-excellent-bg text-badge-excellent-text
                {% elseif trend.value == 'degrading' %}bg-badge-poor-bg text-badge-poor-text
                {% else %}bg-accent-subtle text-text-secondary{% endif %}">
                {% if trend.value == 'improving' %}&uarr;{% elseif trend.value == 'degrading' %}&darr;{% else %}&rarr;{% endif %}
                {{ trend.label }}
            </span>
            <span class="inline-flex items-center h-5.5 px-2 rounded-md text-[11px] font-medium bg-accent-subtle text-text-secondary">{{ audits|length }} audit{{ audits|length != 1 ? 's' : '' }}</span>
        </div>
    </div>
{% endblock %}

{% block page_actions %}
    {% if currentUser is defined and currentUser is not null and currentUser.admin %}
    <form method="post" action="/dashboard/{{ url.id }}/run-audit" onsubmit="this.querySelector('button').disabled=true;this.querySelector('button').textContent='Running...'">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token }}">
        <button type="submit" class="inline-flex items-center h-8 px-3 bg-accent text-white text-[13px] font-medium rounded-lg hover:bg-accent-hover transition-colors duration-150 disabled:opacity-50">
            Run Audit
        </button>
    </form>
    {% endif %}
{% endblock %}

{% block content %}
{# Accessibility Issues #}
{% if issues is defined and issues is not empty %}
<div class="bg-surface-raised border border-border rounded-xl mb-6">
    <div class="px-5 py-3.5 border-b border-border-subtle flex items-center justify-between">
        <h2 class="text-sm font-semibold text-text-primary">Accessibility Issues</h2>
        <span class="text-xs text-text-muted">{{ issues|length }} issue{{ issues|length != 1 ? 's' : '' }}</span>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full table-fixed">
            <colgroup>
                <col style="width: 110px">
                <col style="width: 130px">
                <col>
            </colgroup>
            <thead>
                <tr class="border-b border-border-subtle">
                    <th class="px-5 py-2.5 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Severity</th>
                    <th class="px-5 py-2.5 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Category</th>
                    <th class="px-5 py-2.5 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Description</th>
                </tr>
            </thead>
            <tbody>
                {% for issue in issues %}
                {% set has_details = issue.description or issue.elementSelector or issue.helpUrl %}
                <tr class="border-b border-border-subtle last:border-0 group {% if has_details %}cursor-pointer hover:bg-stone-50 transition-colors duration-150{% endif %}"
                    {% if has_details %}x-data="{ open: false }" @click="open = !open" role="button"{% endif %}>
                    <td class="px-5 py-2">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium
                            {% if issue.severity.value == 'critical' %}bg-badge-poor-bg text-badge-poor-text
                            {% elseif issue.severity.value == 'serious' %}bg-badge-warn-bg text-badge-warn-text
                            {% elseif issue.severity.value == 'moderate' %}bg-badge-good-bg text-badge-good-text
                            {% else %}bg-blue-50 text-blue-700{% endif %}">
                            {{ issue.severity.label }}
                        </span>
                    </td>
                    <td class="px-5 py-2 text-sm text-text-secondary whitespace-nowrap">
                        {{ issue.category.label }}
                    </td>
                    <td class="px-5 py-2 text-sm text-text-primary">
                        <div class="flex items-center gap-1.5">
                            {% if has_details %}
                                <svg width="14" height="14" class="text-text-muted group-hover:text-accent shrink-0 transition-all duration-200" :class="open ? 'rotate-90' : ''" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                            {% endif %}
                            <span>{{ issue.title ?? issue.description }}</span>
                        </div>
                        {% if has_details %}
                        <div x-show="open" x-cloak x-transition.opacity.duration.150ms class="mt-2 ml-5 space-y-1.5">
                            {% if issue.description %}
                                <p class="text-sm text-text-secondary">{{ issue.description }}</p>
                            {% endif %}
                            {% if issue.elementSelector %}
                                <code class="block text-xs text-text-muted font-mono bg-accent-subtle px-1.5 py-0.5 rounded w-fit">{{ issue.elementSelector }}</code>
                            {% endif %}
                            {% if issue.helpUrl %}
                                <a href="{{ issue.helpUrl }}" target="_blank" rel="noopener noreferrer" class="inline-block text-xs text-accent hover:text-accent-hover underline underline-offset-2" @click.stop>Learn more</a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{# Audit History â€” collapsible, closed by default #}
<div class="bg-surface-raised border border-border rounded-xl" x-data="{ open: false }">
    <div class="px-5 py-3.5 flex items-center justify-between cursor-pointer" @click="open = !open">
        <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-text-muted transition-transform duration-200" :class="open ? 'rotate-90' : ''" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
            <h2 class="text-sm font-semibold text-text-primary">Audit History</h2>
        </div>
        <a href="/dashboard/{{ url.id }}/export" class="text-[13px] font-medium text-text-secondary hover:text-text-primary transition-colors" @click.stop>Export CSV</a>
    </div>

    <div x-show="open" x-cloak x-transition.opacity.duration.150ms>
        {% if audits is empty %}
            <div class="p-10 text-center text-sm text-text-muted border-t border-border-subtle">
                No audits have been run yet.
            </div>
        {% else %}
            <div class="overflow-x-auto border-t border-border-subtle">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-border-subtle">
                            <th class="px-5 py-2.5 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Date</th>
                            <th class="px-5 py-2.5 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Score</th>
                            <th class="px-5 py-2.5 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for audit in audits %}
                        <tr class="border-b border-border-subtle last:border-0">
                            <td class="px-5 py-2 text-sm text-text-primary">
                                {{ audit.auditDate|date('Y-m-d H:i') }}
                            </td>
                            <td class="px-5 py-2">
                                <span class="text-sm font-semibold
                                    {% if audit.score.value >= 90 %}text-score-excellent
                                    {% elseif audit.score.value >= 70 %}text-score-good
                                    {% else %}text-score-poor{% endif %}">
                                    {{ audit.score.value }}
                                </span>
                            </td>
                            <td class="px-5 py-2">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium
                                    {% if audit.status.value == 'completed' %}bg-badge-excellent-bg text-badge-excellent-text
                                    {% elseif audit.status.value == 'failed' %}bg-badge-poor-bg text-badge-poor-text
                                    {% else %}bg-badge-good-bg text-badge-good-text{% endif %}">
                                    {{ audit.status.label }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
